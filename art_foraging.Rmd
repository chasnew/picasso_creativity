---
title: "Artistic Movement Analysis"
author: "Chanuwas (New) Aswamenakul"
date: '2022-10-16'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(data.table)
library(lubridate)
library(stringr)
library(entropy)
library(rsample)
library(cowplot)
library(ggrepel)
library(patchwork)

home_dir <- path.expand("~")
picasso_path <- file.path(home_dir, "Library/CloudStorage/Box-Box/QuantifyingPicasso")
```

# Data loading

```{r, warning=FALSE}
art_data <- read.delim("raw_data/artwork1.csv", colClasses = "character") # /t as separator

# parse out date, month, and year variables from existing columns
art_data <- art_data %>% 
  separate(dateEnd, c("yearEnd","monthEnd","dayEnd"), remove = FALSE) %>% 
  separate(dateStart, c("yearStart","monthStart","dayStart"), remove = FALSE) %>% 
  mutate(yearEnd = as.numeric(yearEnd),
         monthEnd = as.numeric(monthEnd),
         dayEnd = as.numeric(dayEnd),
         yearStart = as.numeric(yearStart),
         monthStart = as.numeric(monthStart),
         dayStart = as.numeric(dayStart))

# remove weird data (8 entries)
art_data <- art_data %>%
  filter(category != "25~26-March/1936") %>% # shifted column (fixable)
  filter(category != "") %>% # empty rows
  filter(yearEnd != 0) # 2 entries w/ missing end dates

# number of years to finish
art_data <- art_data %>%
  mutate(yearDuration = yearEnd - yearStart)

# fill months and dates
art_data <- art_data %>% 
  mutate(monthEnd_fix = case_when(monthEnd == 0 ~ 6.5,
                                  TRUE ~ monthEnd),
         dayEnd_fix = case_when(dayEnd == 0 ~ 15.5,
                                  TRUE ~ dayEnd),
         monthStart_fix = case_when(monthStart == 0 ~ 6.5,
                                  TRUE ~ monthStart),
         dayStart_fix = case_when(dayStart == 0 ~ 15.5,
                                  TRUE ~ dayStart)) %>%
  mutate(dateEnd = make_date(yearEnd, monthEnd_fix, dayEnd_fix), # convert dateEnd into date type
         dateStart = make_date(yearStart, monthStart_fix, dayStart_fix), # convert dateStart into date type
         yearMonthStart = yearStart + monthStart_fix/12 + dayStart_fix/365) %>% # convert date into year scale
  mutate(date_duration = dateEnd - dateStart)

# select necessary columns
reduced_art <- art_data %>% 
  select(opp, title, category, dayStart, monthStart, yearStart, yearMonthStart, dateStart)

paintings <- reduced_art %>% 
  filter(category == "painting")

# Set up non-overlapping windows
annualBins <- 12 # 12 months
windowSize <- 1/annualBins # window size on the year scale (1 month)

# major artistic periods
majorPeriodOnset <- tibble(period = c("Blue",
                                      "Rose",
                                      "Les Demoiselles d'Avignon",
                                      "Horta de Hebra landscapes",
                                      "Analytic Cubism",
                                      "Synthetic Cubism",
                                      "WW1 Start",
                                      "Neoclassicism", 
                                      "Surrealism\n(Mandoline et guitare)",
                                      "Surrealism\n(Trois denseurs)"),
                           yearMonthStart = c(1901,
                                              1904, 
                                              1907.583,
                                              1909.750,
                                              1912 + 9/12, # changed from 9/12
                                              1912.5,
                                              1914.5, 
                                              1918, 
                                              1924.583, 
                                              1925+2/12)) %>% 
  mutate(timeWindow = ceiling(yearMonthStart / windowSize) * windowSize,
         onsetYear = floor(timeWindow))
```


# Load PCA results

```{r}
feature_path <- file.path(picasso_path, "data_from_OPP/image_features")
target_cat <- "painting"
feature_model <- "resnet"

full_df <- fread(file.path(feature_path, paste0("pca_", target_cat, "_", feature_model, ".csv"))) %>% 
  as.data.frame()

# Separate low-level and high-level features for analyses
low_cols <- str_detect(colnames(full_df), "low")
low_features <- full_df[low_cols]

high_cols <- str_detect(colnames(full_df), "high")
high_features <- full_df[high_cols]

full_pc_cols <- str_detect(colnames(full_df), "pc")
full_features <- full_df[full_pc_cols]
```

```{r}
# enable local access to Box folders
tmp_filelist <- list.files(feature_path)
```


# Movement characterization

## Characterizing distributions

```{r}
detect_burst <- function(ts, thresh=2, scale=TRUE) {
  if (scale) {
    scaled_ts <- scale(ts, center = TRUE, scale = TRUE)[,1]
    return(scaled_ts > thresh)
  } else {
    return(ts > thresh)
  }
}

extract_iei <- function(burst_df, date_ind=1, burst_ind=2) {
  interval_list <- c()
  interval <- 0
  for (i in 1:nrow(burst_df)) {
    if (burst_df[i,burst_ind]) {
      interval_list <- c(interval_list, interval + burst_df[i,date_ind])
      interval <- 0
    } else {
      interval <- interval + burst_df[i,date_ind]
    }
  }
  return(interval_list)
}

burstiness <- function(iei) {
  sd_iei <- sd(iei)
  avg_iei <- mean(iei)
  
  return((sd_iei - avg_iei)/(sd_iei + avg_iei))
}
```


## Burstiness sensitivity

```{r}
## pre-calculate movement vectors
ordered_df <- full_df %>% 
  left_join(art_data %>% select(opp, dayStart, dateStart),
            by = "opp") %>% 
  filter(monthStart != 0, dayStart != 0) %>% 
  arrange(yearStart, monthStart, dayStart) %>% 
  select(dateStart, low_pc1:high_pc100)

window_size <- 7

first_date <- min(ordered_df$dateStart)
ordered_df <- ordered_df %>% 
  mutate(day_count = as.numeric(dateStart - first_date),
         date_group = floor(day_count/window_size))

agg_pca <- ordered_df %>% 
  group_by(date_group) %>% 
  summarize(across(contains("_pc"), mean))

trimmed_pca1 <- agg_pca[-1,] # remove the first row
trimmed_pca2 <- agg_pca[-nrow(agg_pca),] # remove the last row

mvt_df <- trimmed_pca1 - trimmed_pca2

## Step sizes
step_sizes <- mvt_df %>% 
  mutate(across(contains("_pc"), ~ . ^2)) %>% 
  select(contains("_pc")) %>% 
  rowSums() %>% 
  as.vector() %>% 
  sqrt()

## varying threshold for burstiness calculation
burst_threshs <- seq(-2, 3, by=0.1)

result_list <- list(thresh = c(),
                    burstiness = c(),
                    big_count = c(),
                    iei_sd = c(),
                    iei_mean = c())

for (thresh in burst_threshs) {
  result_list$thresh <- c(result_list$thresh, thresh)
  
  ## Burstiness
  burst_df <- data.frame(date_diff = mvt_df$date_group)
  burst_df$bigstep <- detect_burst(step_sizes, thresh=thresh)
  iei <- extract_iei(burst_df)
  
  result_list$burstiness <- c(result_list$burstiness, burstiness(iei))
  result_list$big_count <- c(result_list$big_count, sum(burst_df$bigstep))
  result_list$iei_sd <- c(result_list$iei_sd, sd(iei))
  result_list$iei_mean <- c(result_list$iei_mean, mean(iei))
}

burstsen_results <- data.frame(result_list)

burstsen_results
burstsen_results %>% 
  ggplot(aes(x=thresh, y=burstiness)) +
  geom_point() +
  xlab("big-step threshold") +
  ylim(c(-1,1)) +
  theme_minimal()


# visualize bursts
# ggplot(tibble(bigstep = as.integer(bigsteps), ind = 1:length(bigsteps)),
#        aes(x = ind, y = bigstep)) +
#   geom_col() +
#   ylim(c(0,10))
```


## Average coarse-graining

```{r movement analysis}
ordered_df <- full_df %>% 
  left_join(art_data %>% select(opp, dayStart, dateStart),
            by = "opp") %>% 
  filter(monthStart != 0, dayStart != 0) %>% 
  arrange(yearStart, monthStart, dayStart) %>% 
  select(dateStart, low_pc1:high_pc100)


# daily level movements
d_ordered_pca <- ordered_df %>% 
  group_by(dateStart) %>% 
  summarize(across(contains("_pc"), mean), .groups = "drop")

trimmed_pca1 <- d_ordered_pca[-1,] # remove the first row
trimmed_pca2 <- d_ordered_pca[-nrow(d_ordered_pca),] # remove the last row

mvt_df <- trimmed_pca1 - trimmed_pca2

## Step sizes
d_step_sizes <- mvt_df %>% 
  mutate(across(contains("_pc"), ~ . ^2)) %>% 
  select(contains("_pc")) %>% 
  rowSums() %>% 
  as.vector() %>% 
  sqrt()

## Directional changes (cosine similarity)
trimmed_mvt1 <- mvt_df[-1,-1] # remove the first row
trimmed_mvt2 <- mvt_df[-nrow(mvt_df),-1] # remove the last row

dot_pca <- rowSums(trimmed_mvt1*trimmed_mvt2)
size_product <- d_step_sizes[-1]*d_step_sizes[-length(d_step_sizes)]

d_cos_sims <- dot_pca/size_product

# monthly level movements
m_ordered_pca <- ordered_df %>% 
  group_by(year(dateStart), month(dateStart)) %>% 
  summarize(across(contains("_pc"), mean), .groups = "drop") %>% 
  select(-1, -2)

trimmed_pca1 <- m_ordered_pca[-1,] # remove the first row
trimmed_pca2 <- m_ordered_pca[-nrow(m_ordered_pca),] # remove the last row

mvt_df <- trimmed_pca1 - trimmed_pca2

## Step sizes
m_step_sizes <- mvt_df %>% 
  mutate(across(contains("_pc"), ~ . ^2)) %>% 
  select(contains("_pc")) %>% 
  rowSums() %>% 
  as.vector() %>% 
  sqrt()

## Directional changes (cosine similarity)
trimmed_mvt1 <- mvt_df[-1,] # remove the first row
trimmed_mvt2 <- mvt_df[-nrow(mvt_df),] # remove the last row

dot_pca <- rowSums(trimmed_mvt1*trimmed_mvt2)
size_product <- m_step_sizes[-1]*m_step_sizes[-length(m_step_sizes)]

m_cos_sims <- dot_pca/size_product

# yearly level movements
y_ordered_pca <- ordered_df %>% 
  group_by(year(dateStart)) %>% 
  summarize(across(contains("_pc"), mean), .groups = "drop") %>% 
  select(-1)

trimmed_pca1 <- y_ordered_pca[-1,] # remove the first row
trimmed_pca2 <- y_ordered_pca[-nrow(y_ordered_pca),] # remove the last row

mvt_df <- trimmed_pca1 - trimmed_pca2

## Step sizes
y_step_sizes <- mvt_df %>% 
  mutate(across(contains("_pc"), ~ . ^2)) %>% 
  select(contains("_pc")) %>% 
  rowSums() %>% 
  as.vector() %>% 
  sqrt()

## Directional changes (cosine similarity)
trimmed_mvt1 <- mvt_df[-1,] # remove the first row
trimmed_mvt2 <- mvt_df[-nrow(mvt_df),] # remove the last row

dot_pca <- rowSums(trimmed_mvt1*trimmed_mvt2)
size_product <- y_step_sizes[-1]*y_step_sizes[-length(y_step_sizes)]

y_cos_sims <- dot_pca/size_product


# Visualizing step sizes
dstep_plot <- qplot(d_step_sizes, bins = 100) +
  xlim(c(0, 250)) +
  labs(title = "daily-level step size") +
  theme_minimal() +
  theme(axis.title.x=element_blank()) 
mstep_plot <- qplot(m_step_sizes, bins = 100) +
  xlim(c(0, 250)) +
  labs(title = "monthly-level step size") +
  theme_minimal() +
  theme(axis.title.x=element_blank()) 
ystep_plot <- qplot(y_step_sizes, bins = 100) +
  xlab("euclidean distance") +
  xlim(c(0, 250)) +
  labs(title = "yearly-level step size") +
  theme_minimal() +
  theme(axis.title.x=element_blank()) 

dstep_plot / mstep_plot / ystep_plot

ggsave(paste0("img/step_size_dist_", feature_model, ".png"))

# Visualizing cosine similarity
csd_plot <- qplot(d_cos_sims, bins = 100) +
  xlim(c(-1, 1)) +
  xlab("cosine similarity") +
  labs(title = "daily-level directional change") +
  theme_minimal() +
  theme(axis.title.x=element_blank())
csm_plot <- qplot(m_cos_sims, bins = 100) +
  xlim(c(-1, 1)) +
  xlab("cosine similarity") +
  labs(title = "monthly-level directional change") +
  theme_minimal() +
  theme(axis.title.x=element_blank())
csy_plot <- qplot(y_cos_sims, bins = 100) +
  xlim(c(-1, 1)) +
  xlab("cosine similarity") +
  labs(title = "yearly-level directional change") +
  theme_minimal() +
  theme(axis.title.x=element_blank())

csd_plot / csm_plot / csy_plot
ggsave(paste0("img/direct_change_dist_", feature_model, ".png"))
```

```{r}
d_ordered_pca$cos_sim <- c(NA, NA, d_cos_sims)

d_ordered_pca <- d_ordered_pca %>% 
  mutate(decadeStart = floor(year(dateStart)/10)*10)

d_ordered_pca %>% 
  ggplot(aes(x = cos_sim)) +
  facet_wrap(~decadeStart) +
  geom_density()

ggplot(data = tibble(t = 1:length(d_cos_sims), d_cos_sims)) +
  geom_line(aes(x = t, y = d_cos_sims))
```

### Seasonality visualization

```{r}
mvt_dates <- d_ordered_pca %>% pull(dateStart)
d_results <- data.frame(dateStart = mvt_dates[-length(mvt_dates)], step_size = d_step_sizes)
d_results$cos_sim <- c(NA, d_cos_sims)

d_results %>% 
  ggplot(aes(x = dateStart, y = step_size)) +
  geom_line()

d_results %>% 
  group_by(month(dateStart)) %>% 
  summarize(avg_step = mean(step_size), avg_dir = mean(cos_sim))
```


## Parametric aggregation

```{r}
ordered_df <- full_df %>% 
  left_join(art_data %>% select(opp, dayStart, dateStart),
            by = "opp") %>% 
  filter(monthStart != 0, dayStart != 0) %>% 
  arrange(yearStart, monthStart, dayStart) %>% 
  select(dateStart, low_pc1:high_pc100)

wsize_list <- c(1, 7, 30, 60, 90, 120, 150, 180, 210, 240, 270, 300, 330, 365, 730)
result_list <- list(window_size = c(),
                    step_avg = c(),
                    step_sd = c(),
                    dir_avg = c(),
                    dir_sd = c(),
                    step_burst = c(),
                    dir_burst = c(),
                    step_dir_cor = c(),
                    step_dir_lag = c(),
                    dir_step_lag = c(),
                    step_acf = c(),
                    dir_acf = c())

step_thresh <- 2
cos_thresh <- 0

for (window_size in wsize_list) {
  result_list$window_size <- c(result_list$window_size, window_size)
  
  first_date <- min(ordered_df$dateStart)
  ordered_df <- ordered_df %>% 
    mutate(day_count = as.numeric(dateStart - first_date),
           date_group = floor(day_count/window_size))
  
  agg_pca <- ordered_df %>% 
    group_by(date_group) %>% 
    summarize(across(contains("_pc"), mean))
  
  trimmed_pca1 <- agg_pca[-1,] # remove the first row
  trimmed_pca2 <- agg_pca[-nrow(agg_pca),] # remove the last row
  
  mvt_df <- trimmed_pca1 - trimmed_pca2
  
  
  ## Step sizes
  step_sizes <- mvt_df %>% 
    mutate(across(contains("_pc"), ~ . ^2)) %>% 
    select(contains("_pc")) %>% 
    rowSums() %>% 
    as.vector() %>% 
    sqrt()
  
  result_list$step_avg <- c(result_list$step_avg, mean(step_sizes))
  result_list$step_sd <- c(result_list$step_sd, sd(step_sizes))
  
  
  ## Directional changes (cosine similarity)
  trimmed_mvt1 <- mvt_df[-1,-1] # remove the first row
  trimmed_mvt2 <- mvt_df[-nrow(mvt_df),-1] # remove the last row
  
  dot_pca <- rowSums(trimmed_mvt1*trimmed_mvt2)
  size_product <- step_sizes[-1]*step_sizes[-length(step_sizes)]
  
  cos_sims <- dot_pca/size_product
  
  result_list$dir_avg <- c(result_list$dir_avg, mean(cos_sims))
  result_list$dir_sd <- c(result_list$dir_sd, sd(cos_sims))
  
  
  ## Burstiness
  burst_df <- data.frame(date_diff = mvt_df$date_group)
  burst_df$bigstep <- detect_burst(step_sizes, thresh=step_thresh)
  step_iei <- extract_iei(burst_df)
  
  result_list$step_burst <- c(result_list$step_burst, burstiness(step_iei))
  
  burst_df$fwd <- c(detect_burst(cos_sims, thresh=cos_thresh, scale=FALSE), FALSE)
  dir_iei <- extract_iei(burst_df, burst_ind = 3)
  
  result_list$dir_burst <- c(result_list$dir_burst, burstiness(dir_iei))
  
  ## Cross- & auto-correlations
  ccf_results <- ccf(step_sizes, cos_sims, lag.max = 1, plot = F)
  
  result_list$step_dir_cor <- c(result_list$step_dir_cor, ccf_results$acf[2])
  result_list$step_dir_lag <- c(result_list$step_dir_lag, ccf_results$acf[3])
  result_list$dir_step_lag <- c(result_list$dir_step_lag, ccf_results$acf[1])
  
  step_acf <- acf(step_sizes, lag.max = 1, plot = F)$acf[2]
  dir_acf <- acf(cos_sims, lag.max = 1, plot = F)$acf[2]
  
  result_list$step_acf <- c(result_list$step_acf, step_acf)
  result_list$dir_acf <- c(result_list$dir_acf, dir_acf)
}

agg_results <- data.frame(result_list)
agg_results

write_csv(agg_results,
          file.path(picasso_path, "results",
                    "mvt_coarsed_results.csv"))
```

```{r}
agg_results <- read_csv(file.path(picasso_path, "results", "mvt_coarsed_results.csv"))
agg_results
```


```{r}
agg_results %>% 
  ggplot(aes(x=window_size)) + 
  geom_line(aes(y=step_avg)) + 
  geom_pointrange(aes(y=step_avg, ymin=step_sd, ymax=step_sd)) +
  scale_y_continuous(limits=c(0, max(agg_results$step_avg))) + 
  theme_classic()

agg_results %>% 
  ggplot(aes(x=step_avg, y=dir_avg, color=window_size)) + 
  geom_line() + 
  geom_point() +
  geom_hline(yintercept=0, linetype='dashed') + 
  geom_vline(xintercept=0, linetype='dashed') + 
  scale_y_continuous(limits=c(-1,1)) + 
  theme_classic()

agg_results %>% 
  ggplot(aes(x=step_avg, y=step_burst, color=window_size)) + 
  geom_line() + 
  geom_point() +
  geom_hline(yintercept=0, linetype='dashed') + 
  geom_vline(xintercept=0, linetype='dashed') + 
  scale_y_continuous(limits=c(-1,1)) +
  theme_classic()

agg_results %>% 
  ggplot(aes(x=step_avg, y=dir_burst, color=window_size)) + 
  geom_line() + 
  geom_point() +
  geom_hline(yintercept=0, linetype='dashed') + 
  geom_vline(xintercept=0, linetype='dashed') + 
  scale_y_continuous(limits=c(-1,1)) +
  theme_classic()
```


## Step sizes at different intervals

```{r}
ordered_df <- full_df %>% 
  left_join(art_data %>% select(opp, dayStart, dateStart),
            by = "opp") %>% 
  filter(yearStart >= 1900, monthStart != 0, dayStart != 0) %>% 
  arrange(yearStart, monthStart, dayStart) %>% 
  select(dateStart, low_pc1:high_pc100)


first_date <- min(ordered_df$dateStart)
last_date <- max(ordered_df$dateStart)

# daily level movements
d_ordered_pca <- ordered_df %>% 
  group_by(dateStart) %>% 
  summarize(across(contains("_pc"), mean), .groups = "drop") %>% 
  complete(dateStart = seq(first_date, last_date, by = "1 day"))


# interval_list <- c(1, 7, 14, 30, 60, 90, 120, 180, 365)
interval_list <- seq(from = 1, to = 365*5, by = 1)
result_list <- list(step_avg = c(),
                    step_sd = c())

for (interval in interval_list) {
  df_nrow <- nrow(d_ordered_pca)
  
  trimmed_pca1 <- d_ordered_pca[-(1:interval),] # remove the first (interval) rows
  trimmed_pca2 <- d_ordered_pca[-((df_nrow-interval+1):df_nrow),] # remove the last (interval) rows
  
  mvt_df <- trimmed_pca1 - trimmed_pca2
  
  ## Step sizes
  d_step_sizes <- mvt_df %>% 
    mutate(across(contains("_pc"), ~ . ^2)) %>% 
    select(contains("_pc")) %>% 
    rowSums() %>% 
    as.vector() %>% 
    sqrt()
  
  result_list$step_avg <- c(result_list$step_avg, mean(d_step_sizes, na.rm = T))
  result_list$step_sd <- c(result_list$step_sd, sd(d_step_sizes, na.rm = T))
}

result_list$interval <- 1:length(result_list$step_avg)
result_df <- data.frame(result_list)

write_csv(result_df,
          file.path(picasso_path, "results",
                    "filtered_steps_diff_intervals.csv"))
```


```{r}
result_df <- read_csv(file.path(picasso_path, "results", "filtered_steps_diff_intervals.csv"))

ggplot(result_df, aes(x = interval, y = step_avg)) +
  geom_point()

ggsave(file.path("img", "filtered_interval_stepsize.png"))
```

### null model

```{r}
# Null results by permutating data based on dates

d_ordered_pca <- full_df %>% 
  left_join(art_data %>% select(opp, dayStart, dateStart),
            by = "opp") %>% 
  filter(yearStart >= 1900, monthStart != 0, dayStart != 0) %>% 
  group_by(dateStart) %>% 
  summarize(across(contains("_pc"), mean), .groups = "drop")

first_date <- min(ordered_df$dateStart)
last_date <- max(ordered_df$dateStart)

# shuffle date column and arrange dataframe
d_ordered_pca <- d_ordered_pca %>% 
  mutate(dateStart = sample(dateStart)) %>% 
  arrange(dateStart) %>% 
  select(dateStart, low_pc1:high_pc100) %>% 
  complete(dateStart = seq(first_date, last_date, by = "1 day"))

# interval_list <- c(1, 7, 14, 30, 60, 90, 120, 180, 365)
interval_list <- seq(from = 1, to = 365*5, by = 1)
result_list <- list(step_avg = c(),
                    step_sd = c())

for (interval in interval_list) {
  df_nrow <- nrow(d_ordered_pca)
  
  trimmed_pca1 <- d_ordered_pca[-(1:interval),] # remove the first (interval) rows
  trimmed_pca2 <- d_ordered_pca[-((df_nrow-interval+1):df_nrow),] # remove the last (interval) rows
  
  mvt_df <- trimmed_pca1 - trimmed_pca2
  
  ## Step sizes
  d_step_sizes <- mvt_df %>% 
    mutate(across(contains("_pc"), ~ . ^2)) %>% 
    select(contains("_pc")) %>% 
    rowSums() %>% 
    as.vector() %>% 
    sqrt()
  
  result_list$step_avg <- c(result_list$step_avg, mean(d_step_sizes, na.rm = T))
  result_list$step_sd <- c(result_list$step_sd, sd(d_step_sizes, na.rm = T))
}

result_list$interval <- interval_list
null_result_df <- data.frame(result_list)

write_csv(null_result_df,
          file.path(picasso_path, "results",
                    "filtered_null_steps_diff_intervals.csv"))
```

```{r}
null_result_df <- read_csv(file.path(picasso_path, "results",
                                     "filtered_null_steps_diff_intervals.csv"))

ggplot(null_result_df, aes(x = interval, y = step_avg)) +
  geom_point()
  # geom_pointrange(aes(ymin = step_avg - step_sd, ymax = step_avg + step_sd)) +
  # ylim(c(-15,60))

ggsave(file.path("img", "filtered_null_interval_stepsize.png"))
```

```{r}
result_df <- read_csv(file.path(picasso_path, "results",
                                "filtered_steps_diff_intervals.csv"))

null_result_df <- read_csv(file.path(picasso_path, "results",
                                     "filtered_null_steps_diff_intervals.csv"))

ggplot(result_df, aes(x = interval, y = step_avg)) +
  geom_point() +
  geom_point(data = null_result_df, color = "red")

ggsave(file.path("img", "picasso_vs_null_interval_stepsize.png"))
```

### subset by decades

```{r}
ordered_df <- full_df %>% 
  left_join(art_data %>% select(opp, dayStart, dateStart),
            by = "opp") %>% 
  filter(yearStart >= 1900, monthStart != 0, dayStart != 0) %>% 
  arrange(yearStart, monthStart, dayStart) %>% 
  select(dateStart, low_pc1:high_pc100)

first_date <- min(ordered_df$dateStart)
last_date <- max(ordered_df$dateStart)

# daily level movements
d_ordered_pca <- ordered_df %>% 
  group_by(dateStart) %>% 
  summarize(across(contains("_pc"), mean), .groups = "drop") %>% 
  complete(dateStart = seq(first_date, last_date, by = "1 day")) %>% 
  mutate(decade = year(dateStart) - (year(dateStart) %% 10))

decade_list <- unique(d_ordered_pca$decade)
result_list <- list()

for (i in length(decade_list)) {
  
  interval_list <- seq(from = 1, to = 365, by = 1)
  decade_result <- list(step_avg = c(),
                        step_sd = c())
  
  decade_pca <- d_ordered_pca %>% 
    filter(decade == decade_list[i])
  
  for (interval in interval_list) {
    df_nrow <- nrow(decade_pca)
    
    trimmed_pca1 <- decade_pca[-(1:interval),] # remove the first (interval) rows
    trimmed_pca2 <- decade_pca[-((df_nrow-interval+1):df_nrow),] # remove the last (interval) rows
    
    mvt_df <- trimmed_pca1 - trimmed_pca2
    
    ## Step sizes
    d_step_sizes <- mvt_df %>% 
      mutate(across(contains("_pc"), ~ . ^2)) %>% 
      select(contains("_pc")) %>% 
      rowSums() %>% 
      as.vector() %>% 
      sqrt()
    
    decade_result$step_avg <- c(decade_result$step_avg, mean(d_step_sizes, na.rm = T))
    decade_result$step_sd <- c(decade_result$step_sd, sd(d_step_sizes, na.rm = T))
  }
  
  decade_result$interval <- 1:length(decade_result$step_avg)
  decade_df <- data.frame(decade_result) %>% 
    mutate(decade = decade_list[i])
  
  result_list[[i]] <- decade_df
}

# bind_rows()

# overlay the overall results with results by decade and color them
# model location change as perturbation to picasso artistic trajectory (related to Alex Peterson)
## quantify effects in step sizes
```


## Turn angle at different intervals
### use 3 data points with fixed time intervals between each pair


## Proportion of exploratory steps at different time scales



## Sliding window analyses

```{r}
ordered_df <- full_df %>% 
  left_join(art_data %>% select(opp, dayStart, dateStart),
            by = "opp") %>% 
  filter(monthStart != 0, dayStart != 0) %>% 
  arrange(yearStart, monthStart, dayStart) %>% 
  select(dateStart, low_pc1:high_pc100)

agg_pca <- ordered_df %>% 
  group_by(dateStart) %>% 
  summarize(across(contains("_pc"), mean))

cos_thresh <- 0

first_date <- ymd(18940101)
last_date <- ymd(19720701)
window_size <- days(30*1)
wstep_size <- days(1)

wfirst_date <- first_date
wlast_date <- first_date + window_size - days(1)

result_list <- list(step_avg = c(),
                    step_sd = c(),
                    dir_avg = c(),
                    dir_sd = c(),
                    step_burst1 = c(),
                    step_burst2 = c(),
                    dir_burst = c())

start_date_seq <- seq(first_date, last_date - window_size + days(1), by = "1 day")
end_date_seq <- seq(wlast_date, last_date, by = "1 day")
# figure out what to do if there's only 1 data point in the window
while (wlast_date <= last_date) {
  # print(paste("start date =", wfirst_date))
  
  # filtering data using the window size
  wagg_pca <- agg_pca %>% 
    filter(dateStart >= wfirst_date, dateStart <= wlast_date)
  
  # check if there's only one data point
  if (nrow(wagg_pca) == 1) {
    result_list$step_avg <- c(result_list$step_avg, 0)
    result_list$step_sd <- c(result_list$step_sd, 0)
    result_list$dir_avg <- c(result_list$dir_avg, 0)
    result_list$dir_sd <- c(result_list$dir_sd, 0)
    result_list$step_burst1 <- c(result_list$step_burst1, NA)
    result_list$step_burst2 <- c(result_list$step_burst2, NA)
    result_list$dir_burst <- c(result_list$dir_burst, NA)
    
    wfirst_date <- wfirst_date + wstep_size
    wlast_date <- wlast_date + wstep_size
    next
  }
  
  trimmed_pca1 <- wagg_pca[-1,] # remove the first row
  trimmed_pca2 <- wagg_pca[-nrow(wagg_pca),] # remove the last row
  
  # movement vectors
  mvt_df <- trimmed_pca1 - trimmed_pca2
  
  ## Step sizes
  step_sizes <- mvt_df %>% 
    mutate(across(contains("_pc"), ~ . ^2)) %>% 
    select(contains("_pc")) %>% 
    rowSums() %>% 
    as.vector() %>% 
    sqrt()
  
  result_list$step_avg <- c(result_list$step_avg, mean(step_sizes))
  result_list$step_sd <- c(result_list$step_sd, sd(step_sizes))
  
  # only calculate if there are at least 2 movement vectors
  if (nrow(mvt_df) > 1) {
    ## Directional changes (cosine similarity)
    trimmed_mvt1 <- mvt_df[-1,-1] # remove the first row
    trimmed_mvt2 <- mvt_df[-nrow(mvt_df),-1] # remove the last row
    
    dot_pca <- rowSums(trimmed_mvt1*trimmed_mvt2)
    size_product <- step_sizes[-1]*step_sizes[-length(step_sizes)]
    
    cos_sims <- dot_pca/size_product
    
    result_list$dir_avg <- c(result_list$dir_avg, mean(cos_sims))
    result_list$dir_sd <- c(result_list$dir_sd, sd(cos_sims))
  
    # 0 bigsteps will be NA
    ## Burstiness
    burst_df <- data.frame(date_diff = mvt_df$dateStart)
    burst_df$bigstep <- detect_burst(step_sizes, thresh=1)
    step_iei1 <- extract_iei(burst_df)
    
    result_list$step_burst1 <- c(result_list$step_burst1, burstiness(step_iei1))
    
    burst_df$bigstep2 <- detect_burst(step_sizes, thresh=2)
    step_iei2 <- extract_iei(burst_df, burst_ind = 3)
    
    result_list$step_burst2 <- c(result_list$step_burst2, burstiness(step_iei2))
    
    burst_df$fwd <- c(detect_burst(cos_sims, thresh=cos_thresh, scale=FALSE), FALSE)
    dir_iei <- extract_iei(burst_df, burst_ind = 4)
    
    result_list$dir_burst <- c(result_list$dir_burst, burstiness(dir_iei))
  } else {
    result_list$dir_avg <- c(result_list$dir_avg, NA)
    result_list$dir_sd <- c(result_list$dir_sd, NA)
    result_list$step_burst1 <- c(result_list$step_burst1, NA)
    result_list$step_burst2 <- c(result_list$step_burst2, NA)
    result_list$dir_burst <- c(result_list$dir_burst, NA)
  }
  
  wfirst_date <- wfirst_date + wstep_size
  wlast_date <- wlast_date + wstep_size
}

slidw_df <- data.frame(result_list)
slidw_df$start_date <- start_date_seq
slidw_df$end_date <- end_date_seq

slidw_df <- slidw_df[,c(8,9,1:7)]
slidw_df

write_csv(slidw_df,
          file.path(picasso_path, "results",
                    "slide_window1m.csv"))
```


```{r}
slidw_df <- read_csv(file.path(picasso_path, "results", "slide_window6m.csv"))

majorPeriodOnset <- majorPeriodOnset %>% 
  mutate(month = ceiling(12 * ((yearMonthStart+.001) - 
                               floor(yearMonthStart))),
         year = floor(yearMonthStart),
         day = "1", 
         yearMonthDay = paste(year, month, day, sep="-")) %>%
  rowwise() %>%
  mutate(start_date = ymd(yearMonthDay))

majorPeriodOnset <- majorPeriodOnset %>%
  left_join(slidw_df %>% select(start_date, step_avg, dir_avg, step_burst1, step_burst2, dir_burst))
```

```{r}
ccf(slidw_df$step_avg, slidw_df$dir_avg, na.action = na.pass, lag.max = 900)
acf(slidw_df$step_avg, na.action = na.pass, lag.max = 800)
acf(nslidw_df$step_avg, na.action = na.pass, lag.max = 800)
acf(slidw_df$dir_avg, na.action = na.pass, lag.max = 800)
acf(nslidw_df$dir_avg, na.action = na.pass, lag.max = 800)
ccf(m_step_sizes, m_cos_sims)
```

Trying to make sense of word CCF — maybe seasonality? 

```{r}
# 1 month visualizations
slidw_df %>% 
  ggplot(aes(x = start_date, y = step_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_avg+.6), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  theme_minimal() +
  theme(legend.position = "none")
  
slidw_df %>% 
  ggplot(aes(x = start_date, y = step_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_avg+5), alpha=.5) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")

slidw_df %>% 
  ggplot(aes(x = start_date, y = dir_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=dir_avg+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  # coord_cartesian(xlim = c(1898,1928)) +
  theme_minimal() +
  theme(legend.position = "none")

slidw_df %>% 
  ggplot(aes(x = start_date, y = dir_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=dir_avg+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")

slidw_df %>% 
  ggplot(aes(x = start_date, y = step_burst1)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_burst1+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  theme_minimal() +
  theme(legend.position = "none")

slidw_df %>% 
  ggplot(aes(x = start_date, y = step_burst1)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_burst1+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")

slidw_df %>% 
  ggplot(aes(x = start_date, y = dir_burst)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=dir_burst+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")
```


```{r}
# 6 month visualizations
slidw_df %>% 
  ggplot(aes(x = start_date, y = step_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_avg+.6), alpha=.5) +
  theme_minimal() +
  theme(legend.position = "none")

ggsave(file.path("img", "slidw_step_size.png"))

slidw_df %>% 
  ggplot(aes(x = start_date, y = step_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_avg+5), alpha=.5) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")

slidw_df %>% 
  ggplot(aes(x = start_date, y = dir_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=dir_avg+.2), alpha=.5) +
  theme_minimal() +
  theme(legend.position = "none")

ggsave(file.path("img", "slidw_dir_change.png"))

slidw_df %>% 
  ggplot(aes(x = start_date, y = dir_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=dir_avg+.2), alpha=.5) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")

slidw_df %>% 
  ggplot(aes(x = start_date, y = step_burst1)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_burst1+.2), alpha=.5) +
  theme_minimal() +
  theme(legend.position = "none")

ggsave(file.path("img", "slidw_burstiness.png"))

slidw_df %>% 
  ggplot(aes(x = start_date, y = step_burst1)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_burst1+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")

slidw_df %>% 
  ggplot(aes(x = start_date, y = dir_burst)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=dir_burst+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")
```

### Null sliding window

```{r, warning=FALSE}
# shuffle date column and arrange dataframe
shuff_df <- full_df %>% 
  left_join(art_data %>% select(opp, dayStart, dateStart),
            by = "opp") %>% 
  filter(monthStart != 0, dayStart != 0) %>% 
  transform(dateStart = sample(dateStart)) %>% 
  arrange(dateStart) %>% 
  select(dateStart, low_pc1:high_pc100)

shuff_df %>% head()

agg_pca <- shuff_df %>% 
  group_by(dateStart) %>% 
  summarize(across(contains("_pc"), mean))

cos_thresh <- 0

first_date <- ymd(18940101)
last_date <- ymd(19720701)
window_size <- days(30*6)
wstep_size <- days(1)

wfirst_date <- first_date
wlast_date <- first_date + window_size - days(1)

result_list <- list(step_avg = c(),
                    step_sd = c(),
                    dir_avg = c(),
                    dir_sd = c(),
                    step_burst1 = c(),
                    step_burst2 = c(),
                    dir_burst = c())

start_date_seq <- seq(first_date, last_date - window_size + days(1), by = "1 day")
end_date_seq <- seq(wlast_date, last_date, by = "1 day")

start_year <- year(wfirst_date)
print(paste("year =", start_year))

# figure out what to do if there's only 1 data point in the window
while (wlast_date <= last_date) {
  if (year(wfirst_date) > start_year) {
    start_year <- year(wfirst_date)
    print(paste("year =", start_year))
  }
  
  # filtering data using the window size
  wagg_pca <- agg_pca %>% 
    filter(dateStart >= wfirst_date, dateStart <= wlast_date)
  
  # check if there's only one data point
  if (nrow(wagg_pca) == 1) {
    result_list$step_avg <- c(result_list$step_avg, 0)
    result_list$step_sd <- c(result_list$step_sd, 0)
    result_list$dir_avg <- c(result_list$dir_avg, 0)
    result_list$dir_sd <- c(result_list$dir_sd, 0)
    result_list$step_burst1 <- c(result_list$step_burst1, NA)
    result_list$step_burst2 <- c(result_list$step_burst2, NA)
    result_list$dir_burst <- c(result_list$dir_burst, NA)
    
    wfirst_date <- wfirst_date + wstep_size
    wlast_date <- wlast_date + wstep_size
    next
  }
  
  trimmed_pca1 <- wagg_pca[-1,] # remove the first row
  trimmed_pca2 <- wagg_pca[-nrow(wagg_pca),] # remove the last row
  
  # movement vectors
  mvt_df <- trimmed_pca1 - trimmed_pca2
  
  ## Step sizes
  step_sizes <- mvt_df %>% 
    mutate(across(contains("_pc"), ~ . ^2)) %>% 
    select(contains("_pc")) %>% 
    rowSums() %>% 
    as.vector() %>% 
    sqrt()
  
  result_list$step_avg <- c(result_list$step_avg, mean(step_sizes))
  result_list$step_sd <- c(result_list$step_sd, sd(step_sizes))
  
  # only calculate if there are at least 2 movement vectors
  if (nrow(mvt_df) > 1) {
    ## Directional changes (cosine similarity)
    trimmed_mvt1 <- mvt_df[-1,-1] # remove the first row
    trimmed_mvt2 <- mvt_df[-nrow(mvt_df),-1] # remove the last row
    
    dot_pca <- rowSums(trimmed_mvt1*trimmed_mvt2)
    size_product <- step_sizes[-1]*step_sizes[-length(step_sizes)]
    
    cos_sims <- dot_pca/size_product
    
    result_list$dir_avg <- c(result_list$dir_avg, mean(cos_sims))
    result_list$dir_sd <- c(result_list$dir_sd, sd(cos_sims))
  
    # 0 bigsteps will be NA
    ## Burstiness
    burst_df <- data.frame(date_diff = mvt_df$dateStart)
    burst_df$bigstep <- detect_burst(step_sizes, thresh=1)
    step_iei1 <- extract_iei(burst_df)
    
    result_list$step_burst1 <- c(result_list$step_burst1, burstiness(step_iei1))
    
    burst_df$bigstep2 <- detect_burst(step_sizes, thresh=2)
    step_iei2 <- extract_iei(burst_df, burst_ind = 3)
    
    result_list$step_burst2 <- c(result_list$step_burst2, burstiness(step_iei2))
    
    burst_df$fwd <- c(detect_burst(cos_sims, thresh=cos_thresh, scale=FALSE), FALSE)
    dir_iei <- extract_iei(burst_df, burst_ind = 4)
    
    result_list$dir_burst <- c(result_list$dir_burst, burstiness(dir_iei))
  } else {
    result_list$dir_avg <- c(result_list$dir_avg, NA)
    result_list$dir_sd <- c(result_list$dir_sd, NA)
    result_list$step_burst1 <- c(result_list$step_burst1, NA)
    result_list$step_burst2 <- c(result_list$step_burst2, NA)
    result_list$dir_burst <- c(result_list$dir_burst, NA)
  }
  
  wfirst_date <- wfirst_date + wstep_size
  wlast_date <- wlast_date + wstep_size
}

slidw_df <- data.frame(result_list)
slidw_df$start_date <- start_date_seq
slidw_df$end_date <- end_date_seq

slidw_df <- slidw_df[,c(8,9,1:7)]
slidw_df
```

```{r}
write_csv(slidw_df,
          file.path(picasso_path, "results",
                    "slide_window_null6m.csv"))
```


```{r}
nslidw_df <- read_csv(file.path(picasso_path, "results", "slide_window_null6m.csv"))

majorPeriodOnset <- majorPeriodOnset %>% 
  mutate(month = ceiling(12 * ((yearMonthStart+.001) - 
                               floor(yearMonthStart))),
         year = floor(yearMonthStart),
         day = "1", 
         yearMonthDay = paste(year, month, day, sep="-")) %>%
  rowwise() %>%
  mutate(start_date = ymd(yearMonthDay))

majorPeriodOnset <- majorPeriodOnset %>%
  left_join(nslidw_df %>% select(start_date, step_avg, dir_avg, step_burst1, step_burst2, dir_burst))
```

```{r}
nslidw_df %>% 
  ggplot(aes(x = start_date, y = step_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_avg+5), alpha=.5) +
  theme_minimal() +
  theme(legend.position = "none")

ggsave(file.path("img", "nslidw_step_size.png"))
  
nslidw_df %>% 
  ggplot(aes(x = start_date, y = step_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_avg+5), alpha=.5) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")

nslidw_df %>% 
  ggplot(aes(x = start_date, y = dir_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=dir_avg+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  # coord_cartesian(xlim = c(1898,1928)) +
  theme_minimal() +
  theme(legend.position = "none")

ggsave(file.path("img", "nslidw_dir_change.png"))

nslidw_df %>% 
  ggplot(aes(x = start_date, y = dir_avg)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=dir_avg+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")

nslidw_df %>% 
  ggplot(aes(x = start_date, y = step_burst1)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_burst1+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  theme_minimal() +
  theme(legend.position = "none")

ggsave(file.path("img", "nslidw_burstiness.png"))

nslidw_df %>% 
  ggplot(aes(x = start_date, y = step_burst1)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_burst1+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")

nslidw_df %>% 
  ggplot(aes(x = start_date, y = dir_burst)) +
  geom_point() +
  geom_vline(xintercept = majorPeriodOnset$start_date, linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=dir_burst+.2), alpha=.5) +
  # scale_x_continuous("year (started)", breaks=seq(1800, 2000, 5)) +
  coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")
```



## Null model

### Average coarse-graining
```{r}
# shuffle date column and arrange dataframe
shuff_df <- full_df %>% 
  left_join(art_data %>% select(opp, dayStart, dateStart),
            by = "opp") %>% 
  filter(monthStart != 0, dayStart != 0) %>% 
  transform(dateStart = sample(dateStart)) %>% 
  arrange(dateStart) %>% 
  select(dateStart, low_pc1:high_pc100)

shuff_df %>% head()

# object-to-object movements
d_ordered_pca <- shuff_df %>% 
  group_by(dateStart) %>% 
  summarize(across(contains("_pc"), mean), .groups = "drop")

trimmed_pca1 <- d_ordered_pca[-1,] # remove the first row
trimmed_pca2 <- d_ordered_pca[-nrow(d_ordered_pca),] # remove the last row

mvt_df <- trimmed_pca1 - trimmed_pca2

## Step sizes
nd_step_sizes <- mvt_df %>% 
  mutate(across(contains("_pc"), ~ . ^2)) %>% 
  select(contains("_pc")) %>% 
  rowSums() %>% 
  as.vector() %>% 
  sqrt()

## Directional changes (cosine similarity)
trimmed_mvt1 <- mvt_df[-1,-1] # remove the first row
trimmed_mvt2 <- mvt_df[-nrow(mvt_df),-1] # remove the last row

dot_pca <- rowSums(trimmed_mvt1*trimmed_mvt2)
size_product <- nd_step_sizes[-1]*nd_step_sizes[-length(nd_step_sizes)]

nd_cos_sims <- dot_pca/size_product

# monthly level movements
m_ordered_pca <- shuff_df %>% 
  group_by(year(dateStart), month(dateStart)) %>% 
  summarize(across(contains("_pc"), mean), .groups = "drop") %>% 
  select(-1, -2)

trimmed_pca1 <- m_ordered_pca[-1,] # remove the first row
trimmed_pca2 <- m_ordered_pca[-nrow(m_ordered_pca),] # remove the last row

mvt_df <- trimmed_pca1 - trimmed_pca2

## Step sizes
nm_step_sizes <- mvt_df %>% 
  mutate(across(contains("_pc"), ~ . ^2)) %>% 
  select(contains("_pc")) %>% 
  rowSums() %>% 
  as.vector() %>% 
  sqrt()

## Directional changes (cosine similarity)
trimmed_mvt1 <- mvt_df[-1,] # remove the first row
trimmed_mvt2 <- mvt_df[-nrow(mvt_df),] # remove the last row

dot_pca <- rowSums(trimmed_mvt1*trimmed_mvt2)
size_product <- nm_step_sizes[-1]*nm_step_sizes[-length(nm_step_sizes)]

nm_cos_sims <- dot_pca/size_product

# yearly level movements
y_ordered_pca <- shuff_df %>% 
  group_by(year(dateStart)) %>% 
  summarize(across(contains("_pc"), mean), .groups = "drop") %>% 
  select(-1)

trimmed_pca1 <- y_ordered_pca[-1,] # remove the first row
trimmed_pca2 <- y_ordered_pca[-nrow(y_ordered_pca),] # remove the last row

mvt_df <- trimmed_pca1 - trimmed_pca2

## Step sizes
ny_step_sizes <- mvt_df %>% 
  mutate(across(contains("_pc"), ~ . ^2)) %>% 
  select(contains("_pc")) %>% 
  rowSums() %>% 
  as.vector() %>% 
  sqrt()

## Directional changes (cosine similarity)
trimmed_mvt1 <- mvt_df[-1,] # remove the first row
trimmed_mvt2 <- mvt_df[-nrow(mvt_df),] # remove the last row

dot_pca <- rowSums(trimmed_mvt1*trimmed_mvt2)
size_product <- ny_step_sizes[-1]*ny_step_sizes[-length(ny_step_sizes)]

ny_cos_sims <- dot_pca/size_product


# Visualizing step sizes
ndstep_plot <- qplot(nd_step_sizes, bins = 100) +
  xlim(c(0, 250)) +
  labs(title = "daily-level step size") +
  theme_minimal() +
  theme(axis.title.x=element_blank()) 
nmstep_plot <- qplot(nm_step_sizes, bins = 100) +
  xlim(c(0, 250)) +
  labs(title = "monthly-level step size") +
  theme_minimal() +
  theme(axis.title.x=element_blank()) 
nystep_plot <- qplot(ny_step_sizes, bins = 100) +
  xlab("euclidean distance") +
  xlim(c(0, 250)) +
  labs(title = "yearly-level step size") +
  theme_minimal() +
  theme(axis.title.x=element_blank()) 

ndstep_plot / nmstep_plot / nystep_plot
ggsave(paste0("img/step_size_dist_null.png"))


# Visualizing cosine similarity
ncsd_plot <- qplot(nd_cos_sims, bins = 100) +
  xlim(c(-1, 1)) +
  xlab("cosine similarity") +
  labs(title = "daily-level directional change") +
  theme_minimal() +
  theme(axis.title.x=element_blank())
ncsm_plot <- qplot(nm_cos_sims, bins = 100) +
  xlim(c(-1, 1)) +
  xlab("cosine similarity") +
  labs(title = "monthly-level directional change") +
  theme_minimal() +
  theme(axis.title.x=element_blank())
ncsy_plot <- qplot(ny_cos_sims, bins = 100) +
  xlim(c(-1, 1)) +
  xlab("cosine similarity") +
  labs(title = "yearly-level directional change") +
  theme_minimal() +
  theme(axis.title.x=element_blank())

ncsd_plot / ncsm_plot / ncsy_plot
ggsave(paste0("img/direct_change_dist_null.png"))
```

#### Comparing burstiness

```{r}
agg_results <- read_csv(file.path(picasso_path, "results", "mvt_coarsed_results.csv"))

nd_step_sizes
```

```{r}
burst_df <- data.frame(date_diff = mvt_df$date_group)
burst_df$bigstep <- detect_burst(step_sizes, thresh=step_thresh)
step_iei <- extract_iei(burst_df)

result_list$step_burst <- c(result_list$step_burst, burstiness(step_iei))
```

#### Comparing autocorr

```{r}
acf(d_step_sizes, lag.max = 400)
acf(nd_step_sizes, lag.max = 400)
ccf(d_step_sizes, d_cos_sims)
ccf(nd_step_sizes, nd_cos_sims)
```

### Significant movements

```{r}
# calculate individual movements for bootstrapping
shuff_df <- full_df %>% 
  left_join(art_data %>% select(opp, dayStart, dateStart),
            by = "opp") %>% 
  filter(monthStart != 0, dayStart != 0) %>% 
  transform(dateStart = sample(dateStart)) %>% 
  arrange(dateStart) %>% 
  select(dateStart, low_pc1:high_pc100)

shuff_df %>% head()

agg_pca <- shuff_df %>% 
  group_by(dateStart) %>% 
  summarize(across(contains("_pc"), mean))

trimmed_pca1 <- agg_pca[-1,] # remove the first row
trimmed_pca2 <- agg_pca[-nrow(agg_pca),] # remove the last row

mvt_df <- trimmed_pca1 - trimmed_pca2

## Step sizes
nd_step_sizes <- mvt_df %>% 
  mutate(across(contains("_pc"), ~ . ^2)) %>% 
  select(contains("_pc")) %>% 
  rowSums() %>% 
  as.vector() %>% 
  sqrt()

## Directional changes (cosine similarity)
trimmed_mvt1 <- mvt_df[-1,-1] # remove the first row
trimmed_mvt2 <- mvt_df[-nrow(mvt_df),-1] # remove the last row

dot_pca <- rowSums(trimmed_mvt1*trimmed_mvt2)
size_product <- nd_step_sizes[-1]*nd_step_sizes[-length(nd_step_sizes)]

nd_cos_sims <- as.vector(dot_pca/size_product)

# Bootstrapping
resample_nslidw <- bootstraps(nd_step_sizes, times = 10)
bootstp_stsz <- sapply(1:1000, function(i) {
    resample <- sample(nd_step_sizes, size = length(nd_step_sizes), replace = T)
    return(mean(resample))
  }
)

## bootstrap results are very narrow
rect_tib <- tibble(low_conf = quantile(bootstp_stsz, probs = .025),
                   upp_conf = quantile(bootstp_stsz, probs = .975))


# bootstrapped results
ggplot() +
  geom_point(data = nslidw_df, aes(x = start_date, y = step_avg)) +
  geom_hline(yintercept = mean(bootstp_stsz), color = "blue") +
  geom_rect(data=rect_tib, aes(xmin = ymd(18920101), xmax = ymd(19740101),
                               ymin = low_conf, ymax = upp_conf), alpha = .5) +
  theme_minimal() +
  theme(legend.position = "none")


# mean and sd
ggplot() +
  geom_point(data = slidw_df, aes(x = start_date, y = step_avg)) +
  geom_hline(yintercept = mean(bootstp_stsz), color = "blue") +
  geom_rect(aes(xmin = ymd(18920101), xmax = ymd(19740101),
                ymin = mean(nslidw_df$step_avg, na.rm = T) - (2*sd(nslidw_df$step_avg, na.rm = T)),
                ymax = mean(nslidw_df$step_avg, na.rm = T) + (2*sd(nslidw_df$step_avg, na.rm = T))),
            alpha = .5) +
  geom_vline(data=majorPeriodOnset, aes(xintercept = start_date, color=period), linetype='dashed') +
  geom_label(data=majorPeriodOnset, aes(x=start_date, label=period, 
                                        color=period, y=step_avg*10+100), alpha=.5) +
  # coord_cartesian(xlim = c(ymd(18980101),ymd(19280101))) +
  theme_minimal() +
  theme(legend.position = "none")
```


## Pairwise measures at multiple scales

```{r}
ordered_df <- full_df %>% 
  left_join(paintings %>% select(opp, dayStart, dateStart),
            by = "opp") %>% 
  filter(monthStart != 0, dayStart != 0) %>% 
  arrange(yearStart, monthStart, dayStart, opp) %>% 
  select(opp, dateStart, low_pc1:high_pc100)

ordered_opp <- ordered_df %>% 
  pull(opp)

exist_dates <- ordered_df %>% 
  pull(dateStart) %>% 
  unique()

date_range <- seq(ymd(18940101), ymd(19720701), by = 'day')
trunc_daterange <- date_range[date_range %in% exist_dates]
pairwise_date <- data.frame(date1 = trunc_daterange[-length(trunc_daterange)],
                            date2 = trunc_daterange[-1])

pairwise_df <- pairwise_date %>% 
  left_join(paintings %>% select(opp, dateStart), by = c("date1" = "dateStart")) %>% 
  rename(opp1 = opp) %>% 
  left_join(paintings %>% select(opp, dateStart), by = c("date2" = "dateStart")) %>% 
  rename(opp2 = opp) %>% 
  mutate(dateDiff = as.numeric(date2 - date1))

pairwise_df %>% 
  left_join(full_df %>% select(opp, low_pc1:high_pc100), by = c("opp1" = "opp")) %>% 
  rename_with(function(col){paste0(col, "_x")}, low_pc1:high_pc100) %>% 
  left_join(full_df %>% select(opp, low_pc1:high_pc100), by = c("opp2" = "opp")) %>% 
  rename_with(function(col){paste0(col, "_y")}, low_pc1:high_pc100)
```


# Stock data

```{r}
# some columns get mixed up by the description column
auc_data <- read.delim("raw_data/auction1.csv") # /t as separatorauc_d

library(stringr)

# can't find upper and lower bounds data, probably due to mis-formatting
auc_data %>% 
  filter(estimateCurrency != "0", estimateLowerBound != "") %>% 
  pull(estimateCurrency)

auc_data %>% str()
```


---
title: "Visual feature extraction"
author: "Chanuwas (New) Aswamenakul"
output: html_notebook
---

# Importing libraries

```{r}
library(tidyverse)
library(abind)
library(lubridate)
library(stringr)
library(imager)
library(tensorflow)
library(keras)
library(Rtsne)
```

# Data loading
```{r}
# artwork tabular data
art_data <- read.delim("raw_data/artwork1.csv", colClasses = "character") # /t as separator

# parse out date, month, and year variables from existing columns
art_data <- art_data %>% 
  separate(dateEnd, c("yearEnd","monthEnd","dayEnd"), remove = FALSE) %>% 
  separate(dateStart, c("yearStart","monthStart","dayStart"), remove = FALSE) %>% 
  mutate(yearEnd = as.numeric(yearEnd),
         monthEnd = as.numeric(monthEnd),
         dayEnd = as.numeric(dayEnd),
         yearStart = as.numeric(yearStart),
         monthStart = as.numeric(monthStart),
         dayStart = as.numeric(dayStart))

# remove weird data (8 entries)
art_data <- art_data %>%
  filter(category != "25~26-March/1936") %>% # shifted column (fixable)
  filter(category != "") %>% # empty rows
  filter(yearEnd != 0) # 2 entries w/ missing end dates

# number of years to finish
art_data <- art_data %>%
  mutate(yearDuration = yearEnd - yearStart)

# fill months and dates
art_data <- art_data %>% 
  mutate(monthEnd_fix = case_when(monthEnd == 0 ~ 6.5,
                                  TRUE ~ monthEnd),
         dayEnd_fix = case_when(dayEnd == 0 ~ 15.5,
                                  TRUE ~ dayEnd),
         monthStart_fix = case_when(monthStart == 0 ~ 6.5,
                                  TRUE ~ monthStart),
         dayStart_fix = case_when(dayStart == 0 ~ 15.5,
                                  TRUE ~ dayStart)) %>%
  mutate(dateEnd = make_date(yearEnd, monthEnd_fix, dayEnd_fix), # convert dateEnd into date type
         dateStart = make_date(yearStart, monthStart_fix, dayStart_fix), # convert dateStart into date type
         yearMonthStart = yearStart + monthStart_fix/12 + dayStart_fix/365) %>% # convert date into year scale
  mutate(date_duration = dateEnd - dateStart)
```
```{r}
# sample image feature extraction
to_plot <- FALSE

# model loading
# vgg16 (https://neurohive.io/en/popular-networks/vgg16/)
base_model <- application_vgg16(weights = 'imagenet')
summary(base_model) # display layer names

# extract intermediate layers
model.conv1 <- keras_model(inputs = base_model$input,
                           outputs = get_layer(base_model, 'block1_conv1')$output)
model.pool1 <- keras_model(inputs = base_model$input,
                           outputs = get_layer(base_model, 'block1_pool')$output)

# image path
sample_dir <- c("Blue", "Rose", "Cubism", "Neoclassicism", "Surrealism")
sample_images <- list.files(file.path("sample_images", sample_dir[1]), full.names = TRUE)
sample_path <- sample_images[1]

# load single image
img <- image_load(sample_path, target_size = c(224,224))

# as.raster to plot
x <- image_to_array(img)

if(to_plot) {
  x %>%
    as.raster(max=255L) %>% 
    plot()
}

x <- array_reshape(x, c(1, dim(x)))
x <- imagenet_preprocess_input(x)

# load multiple images
x <- map(sample_images,
         ~image_load(.x, target_size = c(224,224), grayscale = FALSE) %>% 
           image_to_array() %>% 
           divide_by(255)
         ) %>% # result in list
  array(unlist(x), dim = c(224, 224, 3, length(x))) %>% # convert into an array
  aperm(c(4,1,2,3))

# feature extraction
feature.conv1 <- model.conv1 %>% predict(x)
feature.pool1 <- model.pool1 %>% predict(x)
```

```{r}
# artwork images
sample_dir <- c("Blue", "Rose", "Cubism", "Neoclassicism", "Surrealism")

# model loading
base_model <- application_vgg16(weights = 'imagenet')
# intermediate layers
model.conv1 <- keras_model(inputs = base_model$input,
                           outputs = get_layer(base_model, 'block1_conv1')$output)
model.pool1 <- keras_model(inputs = base_model$input,
                           outputs = get_layer(base_model, 'block1_pool')$output)

sample_features <- c()
sample_labels <- rep(sample_dir, each = 5)
for (period in sample_dir) {
  sample_images <- list.files(file.path("sample_images", period), full.names = TRUE)
  
  x <- map(sample_images,
           ~image_load(.x, target_size = c(224,224), grayscale = FALSE) %>% 
             image_to_array() %>% 
             divide_by(255)
         ) # result in list
  x <- array(unlist(x), dim = c(224, 224, 3, length(x))) %>% # convert into an array
    aperm(c(4,1,2,3))
  
  feature.conv1 <- model.conv1 %>%
    predict(x) %>%
    rowMeans(dims = 2)
  feature.pool1 <- model.pool1 %>% 
    predict(x) %>% 
    rowMeans(dims = 2)
  
  img_features <- cbind(feature.conv1, feature.pool1)
  sample_features <- rbind(sample_features, img_features)
}

# PCA analysis
pca.results <- prcomp(sample_features,
                      center = TRUE,
                      scale. = TRUE)

sample_df <- data.frame(pca.results$x[,1:2])
sample_df$period <- sample_labels

ggplot(data = sample_df, aes(x = PC1, y = PC2, color = period)) +
  geom_point()

# t-SNE analysis
sample_tsne <- sample_features %>% Rtsne(perplexity = 5)
sample_tsne <- sample_tsne$Y %>% as.data.frame() %>% rename(tSNE1 = "V1", tSNE2 = "V2")
sample_tsne$period <- sample_labels

ggplot(data = sample_tsne, aes(x = tSNE1, y = tSNE2, color = period)) +
  geom_point()
```


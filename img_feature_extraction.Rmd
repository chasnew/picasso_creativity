---
title: "Visual feature extraction"
author: "Chanuwas (New) Aswamenakul"
output: html_notebook
---

# Importing libraries

```{r}
library(tidyverse)
library(abind)
library(lubridate)
library(stringr)
library(imager)
library(tensorflow)
library(keras)
library(Rtsne)
library(ggrepel)
```

# Data loading
```{r}
# artwork tabular data
art_data <- read.delim("raw_data/artwork1.csv", colClasses = "character") # /t as separator

# row whose columns are shifted
tmp_ind <- art_data[art_data$opp == "OPP.36:312",] %>% rownames()
art_data[tmp_ind, 2] <- paste(art_data[tmp_ind, 2], art_data[tmp_ind, 3])
for (i in 3:ncol(art_data)-1) {
  art_data[tmp_ind, i] <- art_data[tmp_ind, i+1]
}

# parse out date, month, and year variables from existing columns
art_data <- art_data %>% 
  separate(dateEnd, c("yearEnd","monthEnd","dayEnd"), remove = FALSE) %>% 
  separate(dateStart, c("yearStart","monthStart","dayStart"), remove = FALSE) %>% 
  mutate(yearEnd = as.numeric(yearEnd),
         monthEnd = as.numeric(monthEnd),
         dayEnd = as.numeric(dayEnd),
         yearStart = as.numeric(yearStart),
         monthStart = as.numeric(monthStart),
         dayStart = as.numeric(dayStart))

# remove weird data (7 entries)
art_data <- art_data %>%
  filter(category != "") %>% # empty rows
  filter(yearEnd != 0) # 2 entries w/ missing end dates

# number of years to finish
art_data <- art_data %>%
  mutate(yearDuration = yearEnd - yearStart)

# fill months and dates
art_data <- art_data %>% 
  mutate(monthEnd_fix = case_when(monthEnd == 0 ~ 6.5,
                                  TRUE ~ monthEnd),
         dayEnd_fix = case_when(dayEnd == 0 ~ 15.5,
                                  TRUE ~ dayEnd),
         monthStart_fix = case_when(monthStart == 0 ~ 6.5,
                                  TRUE ~ monthStart),
         dayStart_fix = case_when(dayStart == 0 ~ 15.5,
                                  TRUE ~ dayStart)) %>%
  mutate(dateEnd = make_date(yearEnd, monthEnd_fix, dayEnd_fix), # convert dateEnd into date type
         dateStart = make_date(yearStart, monthStart_fix, dayStart_fix), # convert dateStart into date type
         yearMonthStart = yearStart + monthStart_fix/12 + dayStart_fix/365) %>% # convert date into year scale
  mutate(date_duration = dateEnd - dateStart)

# select necessary columns
reduced_art <- art_data %>% 
  select(opp, title, category, yearStart, yearMonthStart)

paintings <- reduced_art %>% 
  filter(category == "painting")

# Set up non-overlapping windows
annualBins <- 12 # 12 months
windowSize <- 1/annualBins # window size on the year scale (1 month)

# major artistic periods
majorPeriodOnset <- tibble(period = c("Blue",
                                      "Rose",
                                      "Les Demoiselles d'Avignon",
                                      "Horta de Hebra landscapes",
                                      "Analytic Cubism",
                                      "Synthetic Cubism",
                                      "WW1 Start",
                                      "Neoclassicism", 
                                      "Surrealism\n(Mandoline et guitare)",
                                      "Surrealism\n(Trois denseurs)"),
                           yearMonthStart = c(1901,
                                              1904, 
                                              1907.583,
                                              1909.750,
                                              1912 + 9/12, # changed from 9/12
                                              1912.5,
                                              1914.5, 
                                              1918, 
                                              1924.583, 
                                              1925+2/12)) %>% 
  mutate(timeWindow = ceiling(yearMonthStart / windowSize) * windowSize,
         onsetYear = floor(timeWindow))
```

# Code testing
```{r}
# model loading
# vgg16 (https://neurohive.io/en/popular-networks/vgg16/)
base_model <- application_vgg16(weights = 'imagenet')
summary(base_model) # display layer names

# extract intermediate layers
model.conv1 <- keras_model(inputs = base_model$input,
                           outputs = get_layer(base_model, 'block1_conv1')$output)
model.pool1 <- keras_model(inputs = base_model$input,
                           outputs = get_layer(base_model, 'block1_pool')$output)
model.fc2 <- keras_model(inputs = base_model$input,
                         outputs = get_layer(base_model, 'fc2')$output)

# sample images
year_list <- paintings %>% 
  filter(yearStart >= 1900, yearStart <= 1970) %>% 
  pull(yearStart) %>% unique()

sample_paintings <- paintings %>% 
  filter(yearStart >= 1900, yearStart <= 1970) %>% 
  group_by(yearStart) %>% 
  do(head(., 30))

sample_opps <- sample_paintings %>% 
  filter(yearStart == 1901) %>% 
  pull(opp)

# image path
img_dir <- "~/Box/QuantifyingPicasso/data_from_OPP/OPP_images/"

# reconstruct filename from OPP
reconstruct_fn <- function(opp_str) {
  return(paste0("yopp", substr(opp_str, 5, 6), "-", substr(opp_str, 8, 10), ".jpg"))
}

# sample_images <- list.files(file.path("sample_images"), full.names = FALSE)
# sample_path <- paste0("sample_images/", sample_images[1])
# 
# # reconstruct OPP id from file names
# reconstruct_opp <- function(opp) {
#   return(paste0("OPP.", substr(opp, 5, 6), ":", substr(opp, 8, 10)))
# }
# 
# sample_images %>% reconstruct_opp

# load single image
img <- image_load(sample_path, target_size = c(224,224))

# as.raster to plot
x <- image_to_array(img)

if(to_plot) {
  x %>%
    as.raster(max=255L) %>% 
    plot()
}

x <- array_reshape(x, c(1, dim(x)))
x <- imagenet_preprocess_input(x)
```

# Image feature extraction (Samples)
```{r}
# model loading
base_model <- application_vgg16(weights = 'imagenet')
# intermediate layers
model.conv1 <- keras_model(inputs = base_model$input,
                           outputs = get_layer(base_model, 'block1_conv1')$output)
model.pool1 <- keras_model(inputs = base_model$input,
                           outputs = get_layer(base_model, 'block1_pool')$output)
model.fc2 <- keras_model(inputs = base_model$input,
                         outputs = get_layer(base_model, 'fc2')$output)

batch_size <- 30

# retrieve file names
year_list <- paintings %>% 
  pull(yearStart) %>% unique()

sample_paintings <- paintings %>% 
  filter(yearStart >= 1900, yearStart <= 1970) %>% 
  group_by(yearStart) %>% 
  do(head(., batch_size))

# reconstruct filename from OPP
reconstruct_fn <- function(opp_str) {
  return(paste0("yopp", substr(opp_str, 5, 6), "-", substr(opp_str, 8, 10), ".jpg"))
}

img_dir <- "~/Box/QuantifyingPicasso/data_from_OPP/OPP_images"

# enable local access to Box folders
for (year in year_list) {
  tmp_filelist <- list.files(file.path(img_dir, year, "ythumbs"))
}

# extract feature of each year (later convert into batch)
low_features <- c()
high_features <- c()

for (year in year_list) {
  # constrctu file paths
  sample_opps <- sample_paintings %>% 
    filter(yearStart == year) %>% 
    pull(opp)
  
  opp_paths <- sample_opps %>% 
    reconstruct_fn() %>% 
    file.path(img_dir, year, "ythumbs", .)
  
  x <- map(opp_paths,
           ~image_load(.x, target_size = c(224,224), grayscale = FALSE) %>% 
             image_to_array() %>% 
             divide_by(255)
         ) # result in list
  x <- array(unlist(x), dim = c(224, 224, 3, length(x))) %>% # convert into an array
    aperm(c(4,1,2,3))
  
  feature.conv1 <- model.conv1 %>%
    predict(x) %>%
    rowMeans(dims = 2)
  feature.pool1 <- model.pool1 %>% 
    predict(x) %>% 
    rowMeans(dims = 2)
  feature.fc2 <- model.fc2 %>% 
    predict(x)
  
  low_features <- rbind(low_features, cbind(feature.conv1, feature.pool1))
  high_features <- rbind(high_features, feature.fc2)
}

# filter out null (zero-valued) columns
nz_masks <- high_features %>% 
  colSums != 0
high_features <- high_features[,nz_masks]

# PCA analysis for low-leven and high-level features
low_features <- prcomp(low_features, center = TRUE, scale. = TRUE)$x[,1:100]
colnames(low_features) <- paste0("low_pc", 1:100)

high_features <- prcomp(high_features, center = TRUE, scale. = TRUE)$x[,1:100]
colnames(high_features) <- paste0("high_pc", 1:100)

# combine low-level and high-level features
sample_features <- cbind(low_features, high_features)

# split samples into multiple batches/groups
# img_n <- length(sample_images)
# batch_size <- 10
# n_batch <- floor(img_n/batch_size)
# group_labels <- rep(1:n_batch, each = batch_size)
# rem <- img_n %% batch_size
# 
# if (rem != 0) {
#   group_labels <- c(group_labels, rep(n_batch+1, rem))
#   n_batch = n_batch + 1
# }
# 
# path_batches <- split(full_paths, f = group_labels)

# extract features from each batch of images
# low_features <- c()
# high_features <- c()
# sample_features <- c()
# 
# for (path_batch in path_batches) {
#   x <- map(path_batch,
#            ~image_load(.x, target_size = c(224,224), grayscale = FALSE) %>% 
#              image_to_array() %>% 
#              divide_by(255)
#          ) # result in list
#   x <- array(unlist(x), dim = c(224, 224, 3, length(x))) %>% # convert into an array
#     aperm(c(4,1,2,3))
#   
#   feature.conv1 <- model.conv1 %>%
#     predict(x) %>%
#     rowMeans(dims = 2)
#   feature.pool1 <- model.pool1 %>% 
#     predict(x) %>% 
#     rowMeans(dims = 2)
#   feature.fc2 <- model.fc2 %>% 
#     predict(x)
#   
#   low_features <- rbind(low_features, cbind(feature.conv1, feature.pool1))
#   high_features <- rbind(high_features, feature.fc2)
#   
#   img_features <- cbind(feature.conv1, feature.pool1, feature.fc2)
#   sample_features <- rbind(sample_features, img_features)
# }
```

# Dimensionality reduction
```{r}
sample_df <- data.frame(opp = sample_paintings$opp, yearMonthStart = sample_paintings$yearMonthStart)
sample_df <- cbind(sample_df, low_features[,1:2], high_features[,1:2])
sample_df$yearStart <- sample_paintings$yearStart

# t-SNE analysis
low_tsne <- low_features %>% Rtsne(perplexity = 30, pca = FALSE)
low_tsne <- low_tsne$Y %>% as.data.frame() %>% rename(low_tsne1 = "V1", low_tsne2 = "V2")

high_tsne <- high_features %>% Rtsne(perplexity = 30, pca = FALSE)
high_tsne <- high_tsne$Y %>% as.data.frame() %>% rename(high_tsne1 = "V1", high_tsne2 = "V2")

full_tsne <- sample_features %>% Rtsne(perplexity = 30, pca = FALSE)
full_tsne <- full_tsne$Y %>% as.data.frame() %>% rename(full_tsne1 = "V1", full_tsne2 = "V2")

sample_df <- cbind(sample_df, low_tsne, high_tsne, full_tsne)
```
# visualization
```{r}
# PCA
ggplot(data = sample_df, aes(x = low_pc1, y = low_pc2, label = opp, color = yearMonthStart)) +
  geom_point() +
  # geom_text_repel(size = 2.5) +
  scale_color_gradientn(colors = rainbow(7)) +
  labs(title = "low-level PCA results") +
  theme_classic()

ggplot(data = sample_df, aes(x = high_pc1, y = high_pc2, label = opp, color = yearMonthStart)) +
  geom_point() +
  # geom_text_repel(size = 2.5) +
  scale_color_gradient2(midpoint = median(sample_df$yearMonthStart), mid = "grey90") +
  labs(title = "high-level PCA results") +
  theme_classic()

ggplot(data = sample_df, aes(x = low_pc1, y = high_pc1, label = opp, color = yearMonthStart)) +
  geom_point() +
  # geom_text_repel(size = 2.5) +
  scale_color_gradient2(midpoint = median(sample_df$yearMonthStart), mid = "grey90") +
  labs(title = "full PCA results") +
  theme_classic()

# t-SNE
ggplot(data = sample_df, aes(x = low_tsne1, y = low_tsne2, label = opp, color = yearMonthStart)) +
  geom_point() +
  # geom_text_repel(size = 2.5) +
  scale_color_gradient2(midpoint = median(sample_df$yearMonthStart), mid = "grey90") +
  labs(title = "low-level tSNE results") +
  theme_classic()

ggplot(data = sample_df, aes(x = high_tsne1, y = high_tsne2, label = opp, color = yearMonthStart)) +
  geom_point() +
  # geom_text_repel(size = 2.5) +
  scale_color_gradient2(midpoint = median(sample_df$yearMonthStart), mid = "grey90") +
  labs(title = "high-level tSNE results") +
  theme_classic()

ggplot(data = sample_df, aes(x = full_tsne1, y = full_tsne2, label = opp, color = yearMonthStart)) +
  geom_point() +
  # geom_text_repel(size = 2.5) +
  scale_color_gradientn(colors = rainbow(7)) +
  labs(title = "full tSNE results") +
  theme_classic()

# visualize a cluster across levels
clust1 <- sample_df %>% 
  filter(full_tsne1 > 0, full_tsne1 < 6, full_tsne2 <-20) %>% 
  select(opp)
  
ggplot(data = sample_df, aes(x = low_tsne1, y = low_tsne2, label = opp, color = opp %in% clust1$opp)) +
  geom_point() +
  labs(title = "low-level tSNE results") +
  theme_classic()

ggplot(data = sample_df, aes(x = high_tsne1, y = high_tsne2, label = opp, color = opp %in% clust1$opp)) +
  geom_point() +
  labs(title = "high-level tSNE results") +
  theme_classic()

# Artistic walk
agg_tsne <- sample_df %>% 
  group_by(yearStart) %>% 
  summarize(low_tsne1_m = mean(low_tsne1), low_tsne2_m = mean(low_tsne2),
            high_tsne1_m = mean(high_tsne1), high_tsne2_m = mean(high_tsne2),
            full_tsne1_m = mean(full_tsne1), full_tsne2_m = mean(full_tsne2))

agg_tsne %>% 
  ggplot(aes(x = lowtsne1_m, y = lowtsne2_m, color = yearStart)) +
  geom_path() +
  geom_point(aes(shape = yearStart > 1912)) +
  scale_color_gradientn(colors = rainbow(7)) +
  labs(title = "low tSNE results") +
  theme_classic()

agg_tsne %>% 
  ggplot(aes(x = hightsne1_m, y = hightsne2_m, color = yearStart)) +
  geom_path() +
  geom_point(aes(shape = yearStart > 1912)) +
  scale_color_gradientn(colors = rainbow(7)) +
  labs(title = "high tSNE results") +
  theme_classic()

agg_tsne %>% 
  ggplot(aes(x = fulltsne1_m, y = fulltsne2_m, color = yearStart)) +
  geom_path() +
  geom_point(aes(shape = yearStart > 1912)) +
  scale_color_gradientn(colors = rainbow(7)) +
  labs(title = "full tSNE results") +
  theme_classic()
```

# Complete image features
```{r}
feature_path <- "/Users/chanuwasaswamenakul/Box/QuantifyingPicasso/data_from_OPP/image_features"
target_cat <- "painting"

low_features <- fread(file.path(feature_path, paste0("low_feature_", target_cat, ".csv"))) %>% 
  as.data.frame()
high_features <- fread(file.path(feature_path, paste0("high_feature_", target_cat, ".csv"))) %>% 
  as.data.frame()

# filter out null (zero-valued) columns
nz_masks <- high_features %>% 
  colSums != 0
high_features <- high_features[,nz_masks]

# PCA analysis for low-leven and high-level features
low_features <- prcomp(low_features, center = TRUE, scale. = TRUE)$x[,1:100]
colnames(low_features) <- paste0("low_pc", 1:100)

high_features <- prcomp(high_features, center = TRUE, scale. = TRUE)$x[,1:100]
colnames(high_features) <- paste0("high_pc", 1:100)

# combine low-level and high-level features
full_features <- cbind(low_features, high_features)

load("track_list.Rdata")

cat_opps <- reduced_art %>% 
  filter(category == target_cat) %>% 
  pull(opp)
cat_filter <- track_list$opp %in% cat_opps

full_df <- data.frame(opp = track_list$opp[cat_filter]) %>% 
  left_join(reduced_art, by = "opp")
full_df <- cbind(full_df, full_features)

full_df %>% 
  data.table() %>% 
  fwrite(file.path(feature_path, paste0("pca_", target_cat, ".csv")))
```

